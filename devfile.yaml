schemaVersion: 2.2.0
metadata:
  name: java-postgres-food-app
  version: 1.0.0
  displayName: "Java Spring Boot & PostgreSQL"
  description: "A Spring Boot application with a PostgreSQL backend, ready for OpenShift Dev Spaces."
  tags: ["Java", "Spring", "PostgreSQL", "Maven", "Swagger"]

projects:
  - name: devspace-demo
    git:
      remotes:
        origin: "https://github.com/dhananjaymule/devspace-demo.git"

components:
  # --- Maven Tooling ---
  # Defines the container image and settings for our development tools.
  - name: tools
    container:
      image: "registry.access.redhat.com/ubi9/openjdk-17:1.20-2.1721752931"
      memoryLimit: "2Gi"
      volumeMounts:
        - name: m2
          path: /home/user/.m2
      endpoints:
        - name: app-ui
          targetPort: 8080
          protocol: http
        - name: swagger-ui
          targetPort: 8080
          path: /swagger-ui.html
          protocol: http
      env:
        # Pass the database connection details to the application.
        # The 'postgres' hostname matches the component name below.
        - name: SPRING_DATASOURCE_URL
          value: jdbc:postgresql://postgres:5432/fooddb
        - name: SPRING_DATASOURCE_USERNAME
          value: postgres
        - name: SPRING_DATASOURCE_PASSWORD
          value: postgres

  # --- PostgreSQL Database Component ---
  # This component defines the PostgreSQL database as a dedicated container.
  - name: postgres
    container:
      image: registry.redhat.io/rhel9/postgresql-15
      memoryLimit: 512M
      env:
        - name: POSTGRESQL_USER
          value: postgres
        - name: POSTGRESQL_PASSWORD
          value: postgres
        - name: POSTGRESQL_DATABASE
          value: fooddb
      volumeMounts:
        - name: pgdata
          path: /var/lib/pgsql/data
      endpoints:
        - name: postgres
          targetPort: 5432
          exposure: internal

  # --- Persistent Volumes ---
  - name: m2
    volume:
      size: 1Gi
  - name: pgdata
    volume:
      size: 1Gi

commands:
  # 1. Installs dependencies and builds the application JAR.
  - id: 1-build
    exec:
      component: tools
      commandLine: "mvn clean package"
      workingDir: ${PROJECTS_ROOT}/devspace-demo
      group:
        kind: build
        isDefault: true

  # 2. Runs the compiled Java application.
  - id: 2-run
    exec:
      component: tools
      commandLine: "java -jar target/food-ordering-app-0.0.1-SNAPSHOT.jar"
      workingDir: ${PROJECTS_ROOT}/devspace-demo
      group:
        kind: run
        isDefault: true

  # 3. (Optional) Debug command.
  - id: 3-debug
    exec:
      component: tools
      commandLine: "java -Xdebug -Xrunjdwp:server=y,transport=dt_socket,address=5005,suspend=n -jar target/food-ordering-app-0.0.1-SNAPSHOT.jar"
      workingDir: ${PROJECTS_ROOT}/devspace-demo
      group:
        kind: debug
        isDefault: true

